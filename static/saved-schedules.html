<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IntelliSched â€” Saved Schedules</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <style>
    .schedule-card {
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
      background-color: #f8fff8;
    }
    .schedule-card.status-approved {
      background-color: #f0f8f0;
    }
    .schedule-card.status-pending {
      background-color: #fffbf0;
    }
    .schedule-card.status-rejected {
      background-color: #fff5f5;
    }
    .schedule-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .status-pending {
      background-color: #ffc107;
      color: #000;
    }
    .status-approved {
      background-color: #198754;
      color: #fff;
    }
    .status-rejected {
      background-color: #dc3545;
      color: #fff;
    }
    .schedule-actions {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .schedule-card .card-title {
      color: #212529 !important;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark custom-navbar mb-4">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="/chair">
        <i class="bi bi-calendar3-fill me-2" aria-hidden="true"></i>
        <span class="fs-5">IntelliSched</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/chair">Generate</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/chair#data-management-section">Data</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Schedules</a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <button id="logoutBtn" class="btn btn-outline-light btn-sm rounded-pill"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-4 mt-4">
    <!-- Header Section -->
    <div class="card p-4 shadow-sm mb-4 rounded-4 card-mac-style">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-calendar-check me-3" style="font-size: 2rem; color: #b83a3f;"></i>
          <div>
            <h1 class="card-title mb-1 fw-bold">Saved Schedules</h1>
            <p class="text-muted mb-0">View, manage, and track the approval status of your saved schedules.</p>
          </div>
        </div>
        <button id="refreshBtn" class="btn btn-outline-primary">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="card border-0 shadow-sm rounded-3 mb-4" style="background: rgba(255,255,255,0.9);">
      <div class="card-body p-4">
        <div class="d-flex align-items-center mb-3">
          <i class="bi bi-funnel me-2" style="color: #b83a3f;"></i>
          <h5 class="mb-0 fw-semibold">Filters & Search</h5>
        </div>
        <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="statusFilter" class="form-label">Filter by Status</label>
          <select id="statusFilter" class="form-select">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="semesterFilter" class="form-label">Filter by Semester</label>
          <select id="semesterFilter" class="form-select">
            <option value="all">All Semesters</option>
            <option value="1">1st Semester</option>
            <option value="2">2nd Semester</option>
            <option value="3">Summer Semester</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="searchInput" class="form-label">Search Schedules</label>
          <input type="text" id="searchInput" class="form-control" placeholder="Search by name...">
        </div>
      </div>
    </div>

    <!-- Schedules Grid -->
    <div id="schedulesContainer" class="row g-4 px-3">
      <!-- Schedules will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5" style="display: none;">
      <i class="bi bi-calendar-x" style="font-size: 4rem; color: #6c757d;"></i>
      <h3 class="mt-3 text-muted">No Saved Schedules</h3>
      <p class="text-muted">You haven't saved any schedules yet. Go to the <a href="/chair">Schedule</a> page to create and save your first schedule.</p>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading saved schedules...</p>
    </div>
  </div>

  <!-- Schedule Details Modal -->
  <div class="modal fade" id="scheduleDetailsModal" tabindex="-1" aria-labelledby="scheduleDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content card-mac-style">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">
            <i class="bi bi-eye text-primary me-2"></i>
            Schedule Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#viewTable" type="button" role="tab">Table</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="timetable-tab" data-bs-toggle="tab" data-bs-target="#viewTimetable" type="button" role="tab">Timetable</button>
            </li>
          </ul>
          
          <!-- View Filters -->
          <div class="card border-0 shadow-sm rounded-3 mb-3" style="background: rgba(255,255,255,0.9);">
            <div class="card-body p-3">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-funnel me-2" style="color: #b83a3f;"></i>
                <h6 class="mb-0 fw-semibold">Filter Schedule</h6>
              </div>
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label for="viewYearFilter" class="form-label small">Year Level</label>
                  <select id="viewYearFilter" class="form-select form-select-sm">
                    <option value="all">All Years</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="viewSectionFilter" class="form-label small">Section</label>
                  <select id="viewSectionFilter" class="form-select form-select-sm">
                    <option value="all">All Sections</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="viewRoomFilter" class="form-label small">Room</label>
                  <select id="viewRoomFilter" class="form-select form-select-sm">
                    <option value="all">All Rooms</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="viewSearchFilter" class="form-label small">Search</label>
                  <input type="text" id="viewSearchFilter" class="form-control form-control-sm" placeholder="Subject, teacher, room...">
                </div>
              </div>
            </div>
          </div>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="viewTable" role="tabpanel">
          <div id="scheduleDetailsContent">
                <!-- Table view will be loaded here -->
              </div>
            </div>
            <div class="tab-pane fade" id="viewTimetable" role="tabpanel">
              <div id="viewScheduleTimetable">
                <!-- Timetable view will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-mac-style">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="deleteModalLabel">
            <i class="bi bi-trash text-danger me-2"></i>
            Confirm Deletion
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
         <div class="modal-body">
           <p class="mb-0">Are you sure you want to delete this schedule?</p>
           <p class="text-muted small mb-0">This action cannot be undone. The schedule will be removed from the dean's view as well.</p>
         </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash me-1"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-mac-style">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="logoutModalLabel">
            <i class="bi bi-box-arrow-right text-danger me-2"></i>
            Confirm Logout
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Are you sure you want to log out?</p>
          <p class="text-muted small mb-0">You will need to log in again to access the application.</p>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmLogoutBtn">
            <i class="bi bi-box-arrow-right me-1"></i> Yes, Logout
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables
    let allSchedules = [];
    let currentScheduleId = null;

    // Authentication check
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
        return;
      }
      
      const userRole = localStorage.getItem('role');
      if (userRole !== 'chair') {
        alert('Access denied. You do not have permission to access this area.');
        localStorage.removeItem('authToken');
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        window.location.href = '/login';
        return;
      }

      // Update navbar with user info
      const username = localStorage.getItem('username');
      if (username) {
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.innerHTML = `<i class="bi bi-person"></i> ${username} (Chair) <i class="bi bi-box-arrow-right ms-1"></i> Logout`;
      }

      // Load schedules
      loadSchedules();
    });

    // Authentication helper function
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
        return {};
      }
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    // Load saved schedules for chair users
    async function loadSchedules() {
      try {
        const response = await fetch('/saved_schedules', {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const schedules = await response.json();
        
        // Ensure schedules is an array
        if (!Array.isArray(schedules)) {
          console.error('Expected array but got:', schedules);
          throw new Error('Invalid response format');
        }
        
        allSchedules = schedules;
        displaySchedules(allSchedules);
      } catch (error) {
        console.error('Error loading schedules:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('schedulesContainer').innerHTML = 
          '<div class="col-12"><div class="alert alert-danger">Failed to load schedules. Please try again.</div></div>';
      }
    }

    // Display schedules with filtering
    function displaySchedules(schedules) {
      const container = document.getElementById('schedulesContainer');
      const emptyState = document.getElementById('emptyState');
      const loadingState = document.getElementById('loadingState');
      
      loadingState.style.display = 'none';
      
      if (schedules.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      const html = schedules.map(schedule => {
        const statusClass = getStatusClass(schedule.status);
        const statusText = schedule.status ? schedule.status.charAt(0).toUpperCase() + schedule.status.slice(1) : 'Unknown';
        const createdDate = schedule.created_at ? new Date(schedule.created_at).toLocaleDateString() : 'Unknown date';
        
        return `
          <div class="col-md-6 col-lg-4">
            <div class="card schedule-card h-100 ${statusClass}">
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">${schedule.schedule_name || 'Unnamed Schedule'}</h6>
                  <span class="badge status-badge ${statusClass}">${statusText}</span>
                </div>
                <p class="card-text text-muted small mb-2">
                  <strong>ID:</strong> ${schedule.schedule_id}<br>
                  <strong>Semester:</strong> ${schedule.semester || 'N/A'}<br>
                  <strong>Created:</strong> ${createdDate}<br>
                  <strong>Approved:</strong> ${schedule.approved_at ? new Date(schedule.approved_at).toLocaleDateString() : 'N/A'}<br>
                  <strong>Approved by:</strong> ${schedule.approved_by || 'N/A'}
                </p>
                ${schedule.comments ? `<p class="card-text text-muted small mb-3"><strong>Comments:</strong> ${schedule.comments}</p>` : ''}
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-primary" onclick="viewSchedule('${schedule.schedule_id}')">
                    <i class="bi bi-eye me-1"></i> View
                  </button>
                  <button class="btn btn-sm btn-outline-info" onclick="downloadScheduleCSV('${schedule.schedule_id}')">
                    <i class="bi bi-download me-1"></i> CSV
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule('${schedule.schedule_id}')">
                    <i class="bi bi-trash me-1"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    // Get status CSS class
    function getStatusClass(status) {
      switch (status) {
        case 'pending': return 'status-pending';
        case 'approved': return 'status-approved';
        case 'rejected': return 'status-rejected';
        default: return 'status-pending';
      }
    }

    // View schedule details
    async function viewSchedule(scheduleId) {
      try {
        currentScheduleId = scheduleId;
        const modal = new bootstrap.Modal(document.getElementById('scheduleDetailsModal'));
        const container = document.getElementById('scheduleDetailsContent');
        const ttContainer = document.getElementById('viewScheduleTimetable');
        
        // Show loading state
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        ttContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        modal.show();

        const response = await fetch(`/load_schedule?id=${encodeURIComponent(scheduleId)}`, {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          throw new Error('Failed to load schedule details');
        }
        
        const schedule = await response.json();
        const rows = Array.isArray(schedule.schedule) ? schedule.schedule : [];
        
        // Store the data for filtering
        currentViewScheduleData = rows;
        currentViewScheduleMeta = schedule;
        
        // Set up view filters
        setupViewFilters();
        
        // Apply initial filters and render (show all data initially)
        renderViewScheduleTable(rows);
        renderViewScheduleTimetable(rows);
      } catch (error) {
        console.error('Error viewing schedule:', error);
        const container = document.getElementById('scheduleDetailsContent');
        container.innerHTML = `<div class="alert alert-danger">${error.message || 'Error loading schedule details.'}</div>`;
      }
    }

    // Load schedule (redirect to main page)
    function loadSchedule(scheduleId) {
      if (confirm('This will load the schedule in the main scheduler. Continue?')) {
        window.location.href = `/chair?load=${scheduleId}`;
      }
    }

    // Delete schedule
    function deleteSchedule(scheduleId) {
      currentScheduleId = scheduleId;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    // Confirm delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      if (!currentScheduleId) return;
      
      try {
        // Use the new endpoint that can handle both pending and approved schedules
        const response = await fetch(`/api/schedule/${encodeURIComponent(currentScheduleId)}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || 'Failed to delete schedule');
        }
        
        // Remove from local array and refresh display
        allSchedules = allSchedules.filter(s => s.id !== currentScheduleId);
        displaySchedules(allSchedules);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
        
         alert('Schedule deleted successfully.');
      } catch (error) {
        console.error('Error deleting schedule:', error);
        alert('Failed to delete schedule. Please try again.');
      }
    });

    // Download CSV function
    async function downloadScheduleCSV(scheduleId) {
      try {
        const response = await fetch(`/download_schedule?id=${encodeURIComponent(scheduleId)}`, {
          headers: getAuthHeaders()
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `schedule_${scheduleId}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          alert('CSV downloaded successfully!');
        } else {
          const error = await response.json().catch(() => ({}));
          alert(`Error: ${error.detail || 'Failed to download CSV'}`);
        }
      } catch (error) {
        console.error('Error downloading CSV:', error);
        alert('Error downloading CSV. Please try again.');
      }
    }

    // Color coding functions for timetable
    const SUBJECT_COLOR_PALETTE = [
      '#E3F2FD', '#F3E5F5', '#E8F5E8', '#FFF3E0', '#FCE4EC',
      '#E0F2F1', '#FFF8E1', '#F1F8E9', '#E3F2FD', '#F9FBE7',
      '#FFFDE7', '#F3E5F5', '#E8F5E8', '#FFF3E0', '#FCE4EC'
    ];

    const LAB_COLOR_PALETTE = [
      '#FFEBEE', '#FFE0B2', '#FFCDD2', '#F8BBD9', '#E1BEE7',
      '#D1C4E9', '#C5CAE9', '#BBDEFB', '#B3E5FC', '#B2EBF2',
      '#B2DFDB', '#C8E6C9', '#DCEDC8', '#F0F4C3', '#FFF9C4'
    ];

    function hashStringToInt(str) {
      let hash = 0;
      if (str.length === 0) return hash;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash);
    }

    function getSubjectColor(subjectCode, type) {
      const palette = type === 'lab' ? LAB_COLOR_PALETTE : SUBJECT_COLOR_PALETTE;
      const hash = hashStringToInt(subjectCode || '');
      return palette[hash % palette.length];
    }

    function getTextColorForBackground(backgroundColor) {
      // Convert hex to RGB
      const hex = backgroundColor.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      
      // Calculate luminance
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      // Return dark text for light backgrounds, light text for dark backgrounds
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // Global variables for view modal data
    let currentViewScheduleData = [];
    let currentViewScheduleMeta = {};

    // Setup view filters based on current schedule data
    function setupViewFilters() {
      const yearFilter = document.getElementById('viewYearFilter');
      const sectionFilter = document.getElementById('viewSectionFilter');
      const roomFilter = document.getElementById('viewRoomFilter');
      
      // Clear existing options except "All"
      sectionFilter.innerHTML = '<option value="all">All Sections</option>';
      roomFilter.innerHTML = '<option value="all">All Rooms</option>';
      
      if (!currentViewScheduleData || currentViewScheduleData.length === 0) return;
      
      // Get unique sections and rooms
      const sections = [...new Set(currentViewScheduleData.map(item => item.section_id).filter(Boolean))].sort();
      const rooms = [...new Set(currentViewScheduleData.map(item => item.room_id).filter(Boolean))].sort();
      
      // Populate section filter
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
      });
      
      // Populate room filter
      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room;
        option.textContent = room;
        roomFilter.appendChild(option);
      });
      
      // Set up event listeners for filters
      setupViewFilterEventListeners();
    }

    // Setup event listeners for view filters
    function setupViewFilterEventListeners() {
      document.getElementById('viewYearFilter').removeEventListener('change', applyViewFilters);
      document.getElementById('viewSectionFilter').removeEventListener('change', applyViewFilters);
      document.getElementById('viewRoomFilter').removeEventListener('change', applyViewFilters);
      document.getElementById('viewSearchFilter').removeEventListener('input', applyViewFilters);
      
      document.getElementById('viewYearFilter').addEventListener('change', applyViewFilters);
      document.getElementById('viewSectionFilter').addEventListener('change', applyViewFilters);
      document.getElementById('viewRoomFilter').addEventListener('change', applyViewFilters);
      document.getElementById('viewSearchFilter').addEventListener('input', applyViewFilters);
    }

    // Apply view filters and render schedule
    function applyViewFilters() {
      if (!currentViewScheduleData || currentViewScheduleData.length === 0) {
        renderViewScheduleTable([]);
        renderViewScheduleTimetable([]);
        return;
      }
      
      const yearFilter = document.getElementById('viewYearFilter').value;
      const sectionFilter = document.getElementById('viewSectionFilter').value;
      const roomFilter = document.getElementById('viewRoomFilter').value;
      const searchFilter = document.getElementById('viewSearchFilter').value.toLowerCase();
      
      let filtered = currentViewScheduleData.filter(item => {
        // Year filter
        if (yearFilter !== 'all') {
          const yearLevel = extractYearLevel(item.section_id);
          if (yearLevel !== yearFilter) return false;
        }
        
        // Section filter
        if (sectionFilter !== 'all' && item.section_id !== sectionFilter) {
          return false;
        }
        
        // Room filter
        if (roomFilter !== 'all' && item.room_id !== roomFilter) {
          return false;
        }
        
        // Search filter
        if (searchFilter) {
          const searchText = `${item.subject_code || ''} ${item.subject_name || ''} ${item.teacher_name || ''} ${item.room_id || ''}`.toLowerCase();
          if (!searchText.includes(searchFilter)) return false;
        }
        
        return true;
      });
      
      renderViewScheduleTable(filtered);
      renderViewScheduleTimetable(filtered);
    }

    // Extract year level from section ID
    function extractYearLevel(sectionId) {
      if (!sectionId) return '';
      const match = sectionId.match(/^(\d+)/);
      return match ? match[1] : '';
    }

    // Render table view
    function renderViewScheduleTable(filtered) {
      const container = document.getElementById('scheduleDetailsContent');
      
      if (!filtered || filtered.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No classes match the current filters.</div>';
        return;
      }
      
      const html = `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Section</th>
                <th>Subject</th>
                <th>Type</th>
                <th>Teacher</th>
                <th>Room</th>
                <th>Day</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(item => `
                <tr>
                  <td><span class="badge bg-secondary rounded-pill">${item.section_id || 'N/A'}</span></td>
                  <td>
                    <strong>${item.subject_code || 'N/A'}</strong><br>
                    <small class="text-muted">${item.subject_name || 'N/A'}</small>
                  </td>
                  <td><span class="badge bg-info rounded-pill">${item.type || 'N/A'}</span></td>
                  <td>${item.teacher_name || 'N/A'}</td>
                  <td>${item.room_id || 'N/A'}</td>
                  <td>${item.day || 'N/A'}</td>
                  <td>${computeEventTimeRange(item)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Render timetable view - copied from working dean implementation
    function renderViewScheduleTimetable(filtered) {
      const container = document.getElementById('viewScheduleTimetable');
      
      if (!filtered || filtered.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No classes match the current filters.</div>';
        return;
      }

      const timeSlotLabels = [
        "07:00-07:30", "07:30-08:00", "08:00-08:30", "08:30-09:00",
        "09:00-09:30", "09:30-10:00", "10:00-10:30", "10:30-11:00",
        "11:00-11:30", "11:30-12:00", "12:00-12:30", "12:30-13:00",
        "13:00-13:30", "13:30-14:00", "14:00-14:30", "14:30-15:00",
        "15:00-15:30", "15:30-16:00", "16:00-16:30", "16:30-17:00",
        "17:00-17:30", "17:30-18:00"
      ];
      
      const dayLabels = ["Mon","Tue","Wed","Thu","Fri","Sat"];
      
      // Create a timetable matrix to track all events across all time slots
      const timetable = Array.from({length: timeSlotLabels.length}, () => Array.from({length: dayLabels.length}, () => []));
      
      // Populate the timetable with all events
      filtered.forEach(event => {
        const dayIdx = dayLabels.indexOf(event.day);
        const startSlotIdx = timeSlotLabels.indexOf(event.start_time_slot);
        const duration = parseInt(event.duration_slots, 10) || 1;
        
        if (dayIdx !== -1 && startSlotIdx !== -1) {
          // Add event to all time slots it occupies
          for (let i = 0; i < duration && startSlotIdx + i < timeSlotLabels.length; i++) {
            timetable[startSlotIdx + i][dayIdx].push(event);
          }
        }
      });
      
      // Create a map to track which cells should be skipped (due to rowspan)
      const skipCells = new Set();
      
      let tthtml = '<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Time Slot</th>';
      for (const day of dayLabels) tthtml += `<th>${day}</th>`;
      tthtml += '</tr></thead><tbody>';
      
      for (let t = 0; t < timeSlotLabels.length; t++) {
        tthtml += `<tr><th>${timeSlotLabels[t]}</th>`;
        for (let d = 0; d < dayLabels.length; d++) {
          const cellKey = `${t}-${d}`;
          
          // Skip this cell if it's already occupied by a rowspan from above
          if (skipCells.has(cellKey)) {
            continue;
          }
          
          // Find ALL events that START at this time slot and day (including overlapping ones)
          // Only render events that actually start at this time slot, not continuing events
          const eventsStartingHere = filtered.filter(event => {
            const dayIdx = dayLabels.indexOf(event.day);
            const startSlotIdx = timeSlotLabels.indexOf(event.start_time_slot);
            return dayIdx === d && startSlotIdx === t;
          });
          
          if (eventsStartingHere.length > 0) {
            // Remove duplicates based on section + subject + day
            const uniqueEvents = [];
            const seenEvents = new Set();
            eventsStartingHere.forEach(event => {
              const key = `${event.section_id}-${event.subject_code}-${event.day}-${event.start_time_slot}`;
              if (!seenEvents.has(key)) {
                uniqueEvents.push(event);
                seenEvents.add(key);
              }
            });
            
            if (uniqueEvents.length > 0) {
              // Calculate the maximum duration among all events in this slot
              // Ensure duration_slots is parsed as integer, default to 1 if missing
              const maxDuration = Math.max(...uniqueEvents.map(e => parseInt(e.duration_slots, 10) || 1));
              
              // Handle different numbers of overlapping events differently
              if (uniqueEvents.length === 1) {
                // Single event - apply background directly to td like chair interface
                const event = uniqueEvents[0];
                const eventDuration = parseInt(event.duration_slots, 10) || 1;
                const subj = event.subject_name || event.subject_code || '';
                const range = computeEventTimeRange(event);
                const bg = getSubjectColor(event.subject_code, event.type);
                const fg = getTextColorForBackground(bg);
                
                // Mark cells below as occupied by this specific event's rowspan
                for (let i = 1; i < eventDuration && t + i < timeSlotLabels.length; i++) {
                  skipCells.add(`${t + i}-${d}`);
                }
                
                tthtml += `<td rowspan="${eventDuration}" style="background:${bg}; color:${fg}; padding:6px 8px; vertical-align: top;">
                  <b>${subj}</b><br>
                  <small style="opacity:.85;">(${range})</small><br>
                  <small>${event.section_id}</small><br>
                  <small>${event.teacher_name}</small><br>
                  <small>${event.room_id}</small>
                </td>`;
              } else if (uniqueEvents.length >= 2) {
                // 2+ events - use expandable summary for better readability
                // Mark cells below as occupied by this rowspan
                for (let i = 1; i < maxDuration && t + i < timeSlotLabels.length; i++) {
                  skipCells.add(`${t + i}-${d}`);
                }
                
                const totalEvents = uniqueEvents.length;
                const bg = '#f8f9fa';
                const fg = '#495057';
                
                tthtml += `<td rowspan="${maxDuration}" style="vertical-align: top; padding: 1px;">`;
                
                uniqueEvents.forEach((event, index) => {
                  const subj = event.subject_name || event.subject_code || '';
                  const range = computeEventTimeRange(event);
                  const eventBg = getSubjectColor(event.subject_code, event.type);
                  const eventFg = getTextColorForBackground(eventBg);
                  
                  tthtml += `<div style="background:${eventBg}; color:${eventFg}; padding:3px 5px; border-radius:3px; margin:2px 0; font-size:9px; line-height:1.2; border-left: 3px solid ${eventBg};">
                    <b>${subj}</b><br>
                    <small style="opacity:.85;">(${range})</small><br>
                    <small>${event.section_id} â€¢ ${event.teacher_name}</small><br>
                    <small>${event.room_id}</small>
                  </div>`;
                });
                
                tthtml += `</td>`;
              }
            } else {
              tthtml += '<td></td>';
            }
          } else {
            tthtml += '<td></td>';
          }
        }
        tthtml += '</tr>';
      }
      tthtml += '</tbody></table></div>';
      
      container.innerHTML = tthtml;
    }

    // Compute event time range
    function computeEventTimeRange(event) {
      const startTime = event.start_time_slot;
      const duration = parseInt(event.duration_slots, 10) || 1;
      
      if (!startTime) return 'N/A';
      
      // Parse start time (handle both "07:00-07:30" and "07:00" formats)
      const startTimeOnly = startTime.split('-')[0]; // Get just the start time part
      const [startHour, startMinute] = startTimeOnly.split(':').map(Number);
      
      // Validate parsed values
      if (isNaN(startHour) || isNaN(startMinute)) return startTime;
      
      // Calculate end time
      const totalMinutes = startHour * 60 + startMinute + (duration * 30);
      const endHour = Math.floor(totalMinutes / 60);
      const endMinute = totalMinutes % 60;
      
      // Format end time with leading zeros
      const endTime = `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
      
      return `${startTimeOnly}-${endTime}`;
    }


    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('semesterFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const semesterFilter = document.getElementById('semesterFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = allSchedules;
      
      if (statusFilter !== 'all') {
        filtered = filtered.filter(s => s.status === statusFilter);
      }
      
      if (semesterFilter !== 'all') {
        filtered = filtered.filter(s => String(s.semester) === semesterFilter);
      }
      
      if (searchTerm) {
        filtered = filtered.filter(s => 
          (s.schedule_name || '').toLowerCase().includes(searchTerm)
        );
      }
      
      displaySchedules(filtered);
    }

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      loadSchedules();
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function() {
      const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
      logoutModal.show();
    });
    
    document.getElementById('confirmLogoutBtn').addEventListener('click', function() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = '/login';
    });
  </script>
</body>
</html>
