
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IntelliSched â€” Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
        .user-card {
            transition: transform 0.2s;
        }
        .user-card:hover {
            transform: translateY(-2px);
        }
        
    /* Fix notification dropdown visibility */
    .navbar {
      position: relative;
      z-index: 99997 !important;
    }
    
    /* Ensure alerts appear above navbar */
    .alert {
      position: relative;
      z-index: 100000 !important;
      border-left: none !important;
    }
    
    .alert-container {
      position: relative;
      z-index: 100000 !important;
    }
    
    /* Ensure main content doesn't interfere with notifications */
    .container {
      position: relative;
      z-index: 1 !important;
    }
        
        .dropdown {
            position: relative;
            z-index: 10001 !important;
        }
        
        #notificationDropdown {
            position: relative;
            z-index: 99998 !important;
        }
        
        #notificationDropdownMenu {
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            left: auto !important;
            z-index: 99999 !important;
            margin-top: 8px !important;
            min-width: 320px !important;
            max-width: 420px !important;
            max-height: 450px !important;
            overflow-y: auto !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2) !important;
            backdrop-filter: blur(20px) !important;
            background: rgba(255, 255, 255, 0.98) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 20px !important;
            padding: 8px !important;
            /* Hide scrollbar */
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* Internet Explorer 10+ */
        }
        
        #notificationDropdownMenu::-webkit-scrollbar {
            display: none !important; /* WebKit browsers (Chrome, Safari, Edge) */
        }
        
        /* Enhanced notification item styling */
        #notificationDropdownMenu .dropdown-item {
            border-radius: 12px !important;
            margin: 4px 0 !important;
            padding: 12px 16px !important;
            transition: all 0.2s ease !important;
            border: 1px solid transparent !important;
        }
        
        #notificationDropdownMenu .dropdown-item:hover {
            background: rgba(184, 58, 63, 0.08) !important;
            border-color: rgba(184, 58, 63, 0.2) !important;
            transform: translateX(4px) !important;
        }
        
        #notificationDropdownMenu .dropdown-item.bg-light {
            background: rgba(184, 58, 63, 0.05) !important;
            border-color: rgba(184, 58, 63, 0.15) !important;
        }
        
        #notificationDropdownMenu .badge {
            font-size: 0.7rem !important;
            padding: 4px 8px !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
        }
        
        #notificationDropdownMenu .btn-sm {
            padding: 6px 8px !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        }
        
        #notificationDropdownMenu .btn-sm:hover {
            transform: scale(1.05) !important;
        }
        
        #notificationBadge {
            position: absolute !important;
            top: -8px !important;
            right: -8px !important;
            z-index: 10004 !important;
            font-size: 0.7rem !important;
            min-width: 18px !important;
            height: 18px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            pointer-events: none !important;
        }
        
        /* Ensure main content doesn't interfere with notifications */
        .container {
            position: relative;
            z-index: 1 !important;
        }
        
        .card {
            position: relative;
            z-index: 2 !important;
        }
        
        /* Enhanced responsive design */
        @media (max-width: 1200px) {
            .card-mac-style {
                width: 95vw !important;
                max-width: 95vw !important;
            }
        }
        
        @media (max-width: 992px) {
            .card-mac-style {
                width: 98vw !important;
                max-width: 98vw !important;
                margin: 0.5rem;
            }
            
            .navbar-brand .fs-5 {
                font-size: 1.1rem !important;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) {
            .card-mac-style {
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0;
                border-radius: 0;
                left: 0 !important;
                transform: none !important;
                position: relative !important;
            }
            
            .container {
                padding: 0;
                margin: 0;
            }
            
            .navbar-brand .fs-5 {
                font-size: 1rem !important;
            }
            
            .btn {
                padding: 0.35rem 0.7rem;
                font-size: 0.85rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .card-body {
                padding: 1rem !important;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
            }
            
            .d-flex.gap-2 > * {
                width: 100% !important;
                margin-bottom: 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .card-mac-style {
                border-radius: 0;
            }
            
            .navbar {
                padding: 0.5rem 0;
            }
            
            .navbar-brand .fs-5 {
                font-size: 0.9rem !important;
            }
            
            .btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
            
            .card-body {
                padding: 0.75rem !important;
            }
            
            .h1, .h2, .h3, .h4, .h5, .h6 {
                font-size: 1.2rem;
            }
            
            .fs-5 {
                font-size: 1rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .navbar-brand .fs-5 {
                font-size: 0.8rem !important;
            }
            
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .btn-sm {
                padding: 0.15rem 0.3rem;
                font-size: 0.7rem;
            }
            
            .card-body {
                padding: 0.5rem !important;
            }
        }
        
        /* Landscape mobile orientation */
        @media (max-width: 768px) and (orientation: landscape) {
            .card-mac-style {
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .navbar {
                padding: 0.25rem 0;
            }
            
            .container.mt-4 {
                margin-top: 1rem !important;
            }
        }
    </style>
</head>
<body class="admin-dashboard">
    <nav class="navbar navbar-expand-lg navbar-dark custom-navbar mb-4">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-calendar3-fill me-2" aria-hidden="true"></i>
                <span class="fs-5">IntelliSched Admin</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Dashboard</a>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-light btn-sm rounded-pill position-relative" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                                0
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="notificationDropdownMenu" style="min-width: 300px; max-height: 400px; overflow-y: auto;">
                            <li>
                                <div class="dropdown-header d-flex justify-content-between align-items-center">
                                    <span>Notifications</span>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllNotifications()" title="Clear all notifications">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li id="noNotifications" class="dropdown-item-text text-muted text-center py-3">No notifications</li>
                        </ul>
                    </div>
                    <button id="logoutBtn" class="btn btn-outline-light btn-sm rounded-pill"><i class="bi bi-box-arrow-right"></i> Logout</button>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card p-4 shadow-sm mb-4 rounded-4 card-mac-style" style="width:90vw;max-width:100vw;left:50%;transform:translateX(-50%);position:relative;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <i class="bi bi-shield-check-fill me-3" style="font-size: 2rem; color: #b83a3f;"></i>
                            <div>
                                <h1 class="card-title mb-1 fw-bold">Administrative Control Center</h1>
                                <p class="text-muted mb-0">Manage users, system settings, and administrative tasks</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info border-0 rounded-3 mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Admin Access:</strong> You can approve or reject pending user accounts, manage system settings, and view analytics.
                        </div>
                        
                        <!-- Admin Quick Actions -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm rounded-3" style="background: rgba(255,255,255,0.9);">
                                    <div class="card-body text-center p-4">
                                        <i class="bi bi-people-fill mb-3" style="font-size: 2.5rem; color: #b83a3f;"></i>
                                        <h5 class="card-title fw-semibold">User Management</h5>
                                        <p class="card-text small text-muted">Approve or reject pending user accounts</p>
                                        <button class="btn btn-primary btn-sm" id="manageUsersBtn">
                                            <i class="bi bi-people me-1"></i>Manage Users
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm rounded-3" style="background: rgba(255,255,255,0.9);">
                                    <div class="card-body text-center p-4">
                                        <i class="bi bi-gear-fill mb-3" style="font-size: 2.5rem; color: #b83a3f;"></i>
                                        <h5 class="card-title fw-semibold">System Settings</h5>
                                        <p class="card-text small text-muted">Configure system preferences and options</p>
                                        <button class="btn btn-primary btn-sm" id="systemSettingsBtn">
                                            <i class="bi bi-gear me-1"></i>System Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 border-0 shadow-sm rounded-3" style="background: rgba(255,255,255,0.9);">
                                    <div class="card-body text-center p-4">
                                        <i class="bi bi-graph-up mb-3" style="font-size: 2.5rem; color: #b83a3f;"></i>
                                        <h5 class="card-title fw-semibold">Analytics</h5>
                                        <p class="card-text small text-muted">View system usage and performance metrics</p>
                                        <button class="btn btn-primary btn-sm" id="analyticsBtn">
                                            <i class="bi bi-graph-up me-1"></i>Analytics
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Management Section -->
                        <div id="userManagementSection" class="mt-4" style="display: none;">
                            <div class="card border-0 shadow-sm rounded-4" style="background: rgba(255,255,255,0.7);">
                                <div class="card-header border-0 bg-transparent pb-0">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">
                                            <i class="bi bi-people-fill me-2" style="color: #b83a3f;"></i>
                                            User Management
                                        </h5>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="refreshUsers()">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                        </button>
                                    </div>
                                    
                                    <!-- Navigation Tabs -->
                                    <ul class="nav nav-tabs nav-fill" id="userTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active rounded-pill me-1" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                                                <i class="bi bi-clock-history me-1"></i>Pending Approvals
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link rounded-pill" id="all-users-tab" data-bs-toggle="tab" data-bs-target="#all-users" type="button" role="tab">
                                                <i class="bi bi-people me-1"></i>All Users
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="userTabsContent">
                                        <!-- Pending Users Tab -->
                                        <div class="tab-pane fade show active" id="pending" role="tabpanel">
                                            <div id="pendingUsersContainer">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading pending users...</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- All Users Tab -->
                                        <div class="tab-pane fade" id="all-users" role="tabpanel">
                                            <div id="allUsersContainer">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading all users...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Section -->
                        <div id="analyticsSection" class="mt-4" style="display: none;">
                            <div class="card border-0 shadow-sm rounded-4" style="background: rgba(255,255,255,0.7);">
                                <div class="card-header border-0 bg-transparent pb-0">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">
                                            <i class="bi bi-graph-up me-2" style="color: #b83a3f;"></i>
                                            System Analytics
                                        </h5>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="refreshAnalytics()">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                        </button>
                                    </div>
                                    
                                    <!-- Analytics Tabs -->
                                    <ul class="nav nav-tabs nav-fill" id="analyticsTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active rounded-pill me-1" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                                <i class="bi bi-speedometer2 me-1"></i>Overview
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link rounded-pill" id="user-activity-tab" data-bs-toggle="tab" data-bs-target="#user-activity" type="button" role="tab">
                                                <i class="bi bi-people me-1"></i>User Activity
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link rounded-pill" id="system-metrics-tab" data-bs-toggle="tab" data-bs-target="#system-metrics" type="button" role="tab">
                                                <i class="bi bi-cpu me-1"></i>System Metrics
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="analyticsTabsContent">
                                        <!-- Overview Tab -->
                                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                            <div id="analyticsOverviewContainer">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading analytics overview...</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- User Activity Tab -->
                                        <div class="tab-pane fade" id="user-activity" role="tabpanel">
                                            <div id="userActivityContainer">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading user activity data...</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- System Metrics Tab -->
                                        <div class="tab-pane fade" id="system-metrics" role="tabpanel">
                                            <div id="systemMetricsContainer">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading system metrics...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Settings Section -->
                        <div id="systemSettingsSection" class="mt-4" style="display: none;">
                            <div class="card border-0 shadow-sm rounded-4" style="background: rgba(255,255,255,0.7);">
                                <div class="card-header border-0 bg-transparent pb-0">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">
                                            <i class="bi bi-gear-fill me-2" style="color: #b83a3f;"></i>
                                            System Settings
                                        </h5>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="refreshSettings()">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="systemSettingsContainer">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Loading system settings...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-mac-style">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="logoutModalLabel">
                        <i class="bi bi-box-arrow-right text-danger me-2"></i>
                        Confirm Logout
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Are you sure you want to log out?</p>
                    <p class="text-muted small mb-0">You will need to log in again to access the application.</p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmLogoutBtn">
                        <i class="bi bi-box-arrow-right me-1"></i>
                        Yes, Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5 py-4 text-center">
        <div class="container">
            <p class="text-muted mb-0">
                <i class="bi bi-c-circle me-1"></i>
                Copyright IntelliSched. All rights reserved.
            </p>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Authentication check and role-based access control
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Check user role - only admin users should access this page
            const userRole = localStorage.getItem('role');
            if (userRole !== 'admin') {
                alert('Access denied. This area is only accessible to Admin users.');
                localStorage.removeItem('authToken');
                localStorage.removeItem('username');
                localStorage.removeItem('role');
                window.location.href = '/login';
                return;
            }
            
            // Update navbar with user info
            const username = localStorage.getItem('username');
            if (username) {
                const logoutBtn = document.getElementById('logoutBtn');
                logoutBtn.innerHTML = `<i class="bi bi-person"></i> ${username} (Admin) <i class="bi bi-box-arrow-right ms-1"></i> Logout`;
            }
            
            // Initialize user management
            initializeUserManagement();
            
            // Initialize analytics and settings
            initializeAnalyticsAndSettings();
        });
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            // Show confirmation modal
            const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
            logoutModal.show();
        });
        
        // Handle logout confirmation
        document.getElementById('confirmLogoutBtn').addEventListener('click', function() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = '/login';
        });
        
        // User Management Functions
        function initializeUserManagement() {
            document.getElementById('manageUsersBtn').addEventListener('click', function() {
                toggleSection('userManagementSection', 'users', loadPendingUsers);
            });
            
            // Handle tab switching
            document.getElementById('pending-tab').addEventListener('click', function() {
                loadPendingUsers();
            });
            
            document.getElementById('all-users-tab').addEventListener('click', function() {
                loadAllUsers();
            });
        }
        
        async function loadPendingUsers() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/pending_users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load pending users');
                }
                
                const users = await response.json();
                displayPendingUsers(users);
            } catch (error) {
                console.error('Error loading pending users:', error);
                document.getElementById('pendingUsersContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545 !important;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load pending users. Please try again.
                    </div>
                `;
            }
        }
        
        function displayPendingUsers(users) {
            const container = document.getElementById('pendingUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem; filter: drop-shadow(0 4px 8px rgba(40, 167, 69, 0.3));"></i>
                        <h4 class="mt-3 text-success">No Pending Users</h4>
                        <p class="text-muted fs-5">All user accounts have been processed.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row g-4">';
            users.forEach(user => {
                const createdDate = new Date(user.created_at).toLocaleDateString();
                const roleColors = {
                    'dean': 'bg-primary',
                    'chair': 'bg-info', 
                    'secretary': 'bg-warning'
                };
                const roleColor = roleColors[user.role] || 'bg-secondary';
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 shadow-sm rounded-4 h-100 user-card" style="background: rgba(255,255,255,0.7);">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                        <i class="bi bi-person-fill text-white" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold">${user.full_name || user.username}</h6>
                                        <small class="text-muted">@${user.username}</small>
                                    </div>
                                </div>
                                <div class="mb-3 flex-grow-1">
                                    <div class="mb-2">
                                        <i class="bi bi-envelope me-2 text-muted"></i>
                                        <span class="small">${user.email}</span>
                                    </div>
                                    <div class="mb-2">
                                        <i class="bi bi-person-badge me-2 text-muted"></i>
                                        <span class="badge ${roleColor} text-capitalize">${user.role}</span>
                                    </div>
                                    <div class="mb-0">
                                        <i class="bi bi-calendar me-2 text-muted"></i>
                                        <span class="small">Applied: ${createdDate}</span>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm rounded-pill" onclick="approveUser(${user.id})">
                                        <i class="bi bi-check-circle me-1"></i>Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm rounded-pill" onclick="rejectUser(${user.id})">
                                        <i class="bi bi-x-circle me-1"></i>Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function approveUser(userId) {
            if (!confirm('Are you sure you want to approve this user?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/approve_user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to approve user');
                }
                
                showAlert('User approved successfully!', 'success');
                recordActivity('user_approval', `Approved user ID: ${userId}`);
                loadPendingUsers(); // Refresh the list
            } catch (error) {
                console.error('Error approving user:', error);
                showAlert('Failed to approve user. Please try again.', 'danger');
            }
        }
        
        async function rejectUser(userId) {
            const reason = prompt('Please provide a reason for rejection (optional):');
            if (reason === null) return; // User cancelled
            
            if (!confirm('Are you sure you want to reject this user?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/reject_user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason || 'No reason provided' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to reject user');
                }
                
                showAlert('User rejected successfully!', 'success');
                recordActivity('user_rejection', `Rejected user ID: ${userId} - Reason: ${reason || 'No reason provided'}`);
                loadPendingUsers(); // Refresh the list
            } catch (error) {
                console.error('Error rejecting user:', error);
                showAlert('Failed to reject user. Please try again.', 'danger');
            }
        }
        
        async function loadAllUsers() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/all_users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    displayAllUsers(users);
                } else {
                    throw new Error('Failed to load all users');
                }
            } catch (error) {
                document.getElementById('allUsersContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545 !important;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading all users: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayAllUsers(users) {
            const container = document.getElementById('allUsersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-muted">No Users Found</h4>
                        <p class="text-muted fs-5">No users are currently registered in the system.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row g-4">';
            users.forEach(user => {
                const createdDate = new Date(user.created_at).toLocaleDateString();
                const lastLoginDate = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                const roleColors = {
                    'admin': 'bg-danger',
                    'dean': 'bg-primary',
                    'chair': 'bg-info', 
                    'secretary': 'bg-warning'
                };
                const statusColors = {
                    'active': 'bg-success',
                    'pending': 'bg-warning'
                };
                const roleColor = roleColors[user.role] || 'bg-secondary';
                const statusColor = statusColors[user.status] || 'bg-secondary';
                
                // Don't show delete button for current admin user
                const currentUsername = localStorage.getItem('username');
                const isCurrentUser = user.username === currentUsername;
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 shadow-sm rounded-4 h-100 user-card" style="background: rgba(255,255,255,0.7);">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                        <i class="bi bi-person-fill text-white" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold">${user.full_name || user.username}</h6>
                                        <small class="text-muted">@${user.username}</small>
                                    </div>
                                </div>
                                <div class="mb-3 flex-grow-1">
                                    <div class="mb-2">
                                        <i class="bi bi-envelope me-2 text-muted"></i>
                                        <span class="small">${user.email}</span>
                                    </div>
                                    <div class="mb-2">
                                        <i class="bi bi-person-badge me-2 text-muted"></i>
                                        <span class="badge ${roleColor} text-capitalize">${user.role}</span>
                                    </div>
                                    <div class="mb-2">
                                        <i class="bi bi-circle-fill me-2 text-muted"></i>
                                        <span class="badge ${statusColor} text-capitalize">${user.status}</span>
                                    </div>
                                    <div class="mb-2">
                                        <i class="bi bi-calendar me-2 text-muted"></i>
                                        <span class="small">Joined: ${createdDate}</span>
                                    </div>
                                    <div class="mb-0">
                                        <i class="bi bi-clock me-2 text-muted"></i>
                                        <span class="small">Last login: ${lastLoginDate}</span>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    ${isCurrentUser ? 
                                        '<button class="btn btn-outline-secondary btn-sm rounded-pill" disabled><i class="bi bi-person-check me-1"></i>Current User</button>' :
                                        `<button class="btn btn-danger btn-sm rounded-pill" onclick="deleteUser(${user.id}, '${user.username}')">
                                            <i class="bi bi-trash me-1"></i>Delete User
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/delete_user/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showAlert(`User "${username}" deleted successfully`, 'success');
                    loadAllUsers(); // Refresh the all users list
                    loadPendingUsers(); // Also refresh pending users in case status changed
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Failed to delete user', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting user: ' + error.message, 'danger');
            }
        }
        
        function refreshUsers() {
            const activeTab = document.querySelector('#userTabsContent .tab-pane.active');
            if (activeTab && activeTab.id === 'pending') {
                loadPendingUsers();
            } else if (activeTab && activeTab.id === 'all-users') {
                loadAllUsers();
            }
        }
        
        function showNotification(message, type = 'info', duration = 5000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
            
            notification.innerHTML = `
                <i class="bi bi-${getIconForType(type)} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // Alias function for compatibility with existing code
        function showAlert(message, type = 'info') {
            showNotification(message, type);
        }

        // Fix notification dropdown responsive positioning
        function fixNotificationDropdownResponsive() {
            const dropdown = document.getElementById('notificationDropdownMenu');
            const dropdownToggle = document.getElementById('notificationDropdown');
            
            if (dropdown && dropdownToggle) {
                // Handle dropdown show event
                dropdown.addEventListener('show.bs.dropdown', function() {
                    const width = window.innerWidth;
                    
                    if (width <= 575.98) {
                        // Extra small devices (phones)
                        this.style.position = 'fixed';
                        this.style.top = '70px';
                        this.style.right = '10px';
                        this.style.left = '10px';
                        this.style.minWidth = 'auto';
                        this.style.maxWidth = 'none';
                        this.style.width = 'auto';
                        this.style.zIndex = '1050';
                        this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                        this.style.maxHeight = '70vh';
                        this.style.overflowY = 'auto';
                        this.style.fontSize = '0.9rem';
                    } else if (width <= 767.98) {
                        // Small devices (landscape phones)
                        this.style.position = 'fixed';
                        this.style.top = '80px';
                        this.style.right = '15px';
                        this.style.left = '15px';
                        this.style.minWidth = 'auto';
                        this.style.maxWidth = 'none';
                        this.style.width = 'auto';
                        this.style.zIndex = '1050';
                        this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                        this.style.maxHeight = '65vh';
                        this.style.overflowY = 'auto';
                        this.style.fontSize = '';
                    } else if (width <= 991.98) {
                        // Medium devices (tablets)
                        this.style.position = '';
                        this.style.top = '';
                        this.style.right = '';
                        this.style.left = '';
                        this.style.minWidth = '350px';
                        this.style.maxWidth = '450px';
                        this.style.width = '';
                        this.style.zIndex = '';
                        this.style.boxShadow = '';
                        this.style.maxHeight = '50vh';
                        this.style.overflowY = 'auto';
                        this.style.fontSize = '';
                    } else if (width < 1200) {
                        // Large devices (desktops)
                        this.style.position = '';
                        this.style.top = '';
                        this.style.right = '';
                        this.style.left = '';
                        this.style.minWidth = '450px';
                        this.style.maxWidth = '600px';
                        this.style.width = '';
                        this.style.zIndex = '';
                        this.style.boxShadow = '';
                        this.style.maxHeight = '500px';
                        this.style.overflowY = 'auto';
                        this.style.fontSize = '';
                    } else {
                        // Extra large devices (large desktops)
                        this.style.position = '';
                        this.style.top = '';
                        this.style.right = '';
                        this.style.left = '';
                        this.style.minWidth = '500px';
                        this.style.maxWidth = '700px';
                        this.style.width = '';
                        this.style.zIndex = '';
                        this.style.boxShadow = '';
                        this.style.maxHeight = '600px';
                        this.style.overflowY = 'auto';
                        this.style.fontSize = '';
                    }
                });
            }
        }

        // Initialize responsive dropdown fix
        document.addEventListener('DOMContentLoaded', function() {
            fixNotificationDropdownResponsive();
        });

        function getIconForType(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Notification functions
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const notifications = await response.json();
                    displayNotifications(notifications);
                    updateNotificationBadge(notifications);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function loadUnreadNotifications() {
            try {
                const response = await fetch('/api/notifications/unread', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const notifications = await response.json();
                    return notifications;
                }
            } catch (error) {
                console.error('Error loading unread notifications:', error);
            }
            return [];
        }

        function displayNotifications(notifications) {
            const dropdownMenu = document.getElementById('notificationDropdownMenu');
            const noNotifications = document.getElementById('noNotifications');
            
            if (!dropdownMenu) return;
            
            // Clear existing notifications (except header and divider)
            const existingItems = dropdownMenu.querySelectorAll('.notification-item');
            existingItems.forEach(item => item.remove());
            
            if (notifications.length === 0) {
                noNotifications.style.display = 'block';
                return;
            }
            
            noNotifications.style.display = 'none';
            
            notifications.forEach(notification => {
                const notificationItem = createNotificationItem(notification);
                dropdownMenu.appendChild(notificationItem);
            });
        }

        function createNotificationItem(notification) {
            const li = document.createElement('li');
            li.className = 'notification-item';
            
            const typeClass = getNotificationTypeClass(notification.type);
            const timeAgo = getTimeAgo(notification.created_at);
            
            li.innerHTML = `
                <div class="dropdown-item ${notification.is_read ? '' : 'bg-light'}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi ${getNotificationIcon(notification.type)} ${typeClass} me-2"></i>
                                <strong class="text-dark">${notification.title}</strong>
                            </div>
                            <p class="mb-1 text-muted small">${notification.message}</p>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            ${!notification.is_read ? '<span class="badge bg-primary rounded-pill">New</span>' : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteNotification(${notification.id})" title="Delete notification">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handler to mark as read (only for the main content area, not buttons)
            li.addEventListener('click', async (e) => {
                if (!e.target.closest('button') && !notification.is_read) {
                    await markNotificationAsRead(notification.id);
                    notification.is_read = true;
                    li.querySelector('.dropdown-item').classList.remove('bg-light');
                    const badge = li.querySelector('.badge');
                    if (badge) badge.remove();
                    updateNotificationBadge(await loadUnreadNotifications());
                }
            });
            
            return li;
        }

        function getNotificationTypeClass(type) {
            switch (type) {
                case 'success': return 'text-success';
                case 'warning': return 'text-warning';
                case 'error': return 'text-danger';
                case 'info': 
                default: return 'text-info';
            }
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'bi-check-circle-fill';
                case 'warning': return 'bi-exclamation-triangle-fill';
                case 'error': return 'bi-x-circle-fill';
                case 'info': 
                default: return 'bi-info-circle-fill';
            }
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.is_read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    console.error('Failed to mark notification as read');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showNotification('Notification not found or already deleted.', 'warning');
                    } else {
                        showNotification('Failed to delete notification. Please try again.', 'danger');
                    }
                    console.error('Failed to delete notification:', response.status, response.statusText);
                } else {
                    showNotification('Notification deleted successfully.', 'success');
                    // Reload notifications after deletion
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                showNotification('Error deleting notification. Please check your connection.', 'danger');
            }
        }

        async function clearAllNotifications() {
            if (!confirm('Are you sure you want to delete all notifications? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Get all notifications first
                const response = await fetch('/api/notifications', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    showNotification('Failed to load notifications.', 'danger');
                    return;
                }
                
                const notifications = await response.json();
                
                if (notifications.length === 0) {
                    showNotification('No notifications to delete.', 'info');
                    return;
                }
                
                // Delete all notifications
                const deletePromises = notifications.map(notification => 
                    fetch(`/api/notifications/${notification.id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    })
                );
                
                await Promise.all(deletePromises);
                showNotification(`Successfully deleted ${notifications.length} notifications.`, 'success');
                
                // Reload notifications
                await loadNotifications();
                
            } catch (error) {
                console.error('Error clearing all notifications:', error);
                showNotification('Error clearing notifications. Please try again.', 'danger');
            }
        }

        // Load notifications on page load
        loadNotifications();
        
        // Auto-refresh notifications every 30 seconds
        setInterval(loadNotifications, 30000);
        
        // Helper function for auth headers
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // Function to record user activity
        async function recordActivity(activityType, description) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/analytics/record-activity?activity_type=${encodeURIComponent(activityType)}&description=${encodeURIComponent(description)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('Failed to record activity:', activityType);
                }
            } catch (error) {
                console.warn('Error recording activity:', error);
            }
        }
        
        // Section toggle function with mutual exclusivity
        function toggleSection(sectionId, sectionType, loadFunction) {
            const targetSection = document.getElementById(sectionId);
            const isCurrentlyVisible = targetSection.style.display !== 'none';
            
            // Close all other sections first
            const allSections = [
                'userManagementSection',
                'analyticsSection', 
                'systemSettingsSection'
            ];
            
            allSections.forEach(id => {
                if (id !== sectionId) {
                    const section = document.getElementById(id);
                    if (section) {
                        section.style.display = 'none';
                    }
                }
            });
            
            // Toggle the target section
            if (isCurrentlyVisible) {
                // If it's currently visible, hide it
                targetSection.style.display = 'none';
            } else {
                // If it's hidden, show it and load data
                targetSection.style.display = 'block';
                
                // Record activity for opening sections
                if (sectionId === 'userManagementSection') {
                    recordActivity('admin_user_management', 'Opened user management section');
                } else if (sectionId === 'analyticsSection') {
                    recordActivity('admin_analytics', 'Opened analytics section');
                } else if (sectionId === 'systemSettingsSection') {
                    recordActivity('admin_settings', 'Opened system settings section');
                }
                
                if (typeof loadFunction === 'function') {
                    loadFunction();
                }
            }
        }
        
        // Analytics and Settings Functions
        function initializeAnalyticsAndSettings() {
            // Analytics button
            document.getElementById('analyticsBtn').addEventListener('click', function() {
                toggleSection('analyticsSection', 'analytics', loadAnalyticsOverview);
            });
            
            // System Settings button
            document.getElementById('systemSettingsBtn').addEventListener('click', function() {
                toggleSection('systemSettingsSection', 'settings', loadSystemSettings);
            });
            
            // Analytics tab switching
            document.getElementById('overview-tab').addEventListener('click', function() {
                loadAnalyticsOverview();
            });
            
            document.getElementById('user-activity-tab').addEventListener('click', function() {
                loadUserActivity();
            });
            
            document.getElementById('system-metrics-tab').addEventListener('click', function() {
                loadSystemMetrics();
            });
        }
        
        async function loadAnalyticsOverview() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/analytics/overview', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load analytics overview');
                }
                
                const data = await response.json();
                displayAnalyticsOverview(data);
            } catch (error) {
                console.error('Error loading analytics overview:', error);
                document.getElementById('analyticsOverviewContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load analytics overview. Please try again.
                    </div>
                `;
            }
        }
        
        function displayAnalyticsOverview(data) {
            const container = document.getElementById('analyticsOverviewContainer');
            
            let html = `
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm rounded-4 text-center" style="background: rgba(40, 167, 69, 0.1);">
                            <div class="card-body">
                                <i class="bi bi-people-fill text-success mb-2" style="font-size: 2rem;"></i>
                                <h5 class="card-title text-success">Total Users</h5>
                                <h3 class="text-success">${data.user_statistics.reduce((sum, stat) => sum + parseInt(stat.count), 0)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm rounded-4 text-center" style="background: rgba(0, 123, 255, 0.1);">
                            <div class="card-body">
                                <i class="bi bi-calendar-check-fill text-primary mb-2" style="font-size: 2rem;"></i>
                                <h5 class="card-title text-primary">Total Schedules</h5>
                                <h3 class="text-primary">${data.schedule_statistics.reduce((sum, stat) => sum + parseInt(stat.count), 0)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm rounded-4 text-center" style="background: rgba(255, 193, 7, 0.1);">
                            <div class="card-body">
                                <i class="bi bi-book-fill text-warning mb-2" style="font-size: 2rem;"></i>
                                <h5 class="card-title text-warning">Total Courses</h5>
                                <h3 class="text-warning">${data.data_counts.find(d => d.type === 'subjects')?.count || 0}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm rounded-4 text-center" style="background: rgba(220, 53, 69, 0.1);">
                            <div class="card-body">
                                <i class="bi bi-person-badge-fill text-danger mb-2" style="font-size: 2rem;"></i>
                                <h5 class="card-title text-danger">Total Teachers</h5>
                                <h3 class="text-danger">${data.data_counts.find(d => d.type === 'teachers')?.count || 0}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="mb-0"><i class="bi bi-people me-2"></i>User Statistics</h6>
                            </div>
                            <div class="card-body">
                                ${data.user_statistics.map(stat => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-${getRoleColor(stat.role)} me-2">${stat.role}</span>
                                        <span class="badge bg-${getStatusColor(stat.status)} me-2">${stat.status}</span>
                                        <strong>${stat.count}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Schedule Statistics</h6>
                            </div>
                            <div class="card-body">
                                ${data.schedule_statistics.map(stat => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-${getScheduleStatusColor(stat.status)} me-2">${stat.status}</span>
                                        <strong>${stat.count}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function loadUserActivity() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/analytics/user-activity?days=30', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load user activity');
                }
                
                const data = await response.json();
                displayUserActivity(data);
            } catch (error) {
                console.error('Error loading user activity:', error);
                document.getElementById('userActivityContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load user activity data. Please try again.
                    </div>
                `;
            }
        }
        
        function displayUserActivity(data) {
            const container = document.getElementById('userActivityContainer');
            
            let html = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Activity by Type</h6>
                            </div>
                            <div class="card-body">
                                ${data.activities_by_type.map(activity => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>${activity.activity_type}</span>
                                        <span class="badge bg-primary">${activity.count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="mb-0"><i class="bi bi-person-check me-2"></i>Top Active Users</h6>
                            </div>
                            <div class="card-body">
                                ${data.top_active_users.map(user => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>${user.full_name || user.username}</strong>
                                            <br><small class="text-muted">${user.role}</small>
                                        </div>
                                        <span class="badge bg-info">${user.activity_count || 0}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function loadSystemMetrics() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/analytics/overview', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load system metrics');
                }
                
                const data = await response.json();
                displaySystemMetrics(data);
            } catch (error) {
                console.error('Error loading system metrics:', error);
                document.getElementById('systemMetricsContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load system metrics. Please try again.
                    </div>
                `;
            }
        }
        
        function displaySystemMetrics(data) {
            const container = document.getElementById('systemMetricsContainer');
            
            let html = `
                <div class="row g-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-transparent border-0">
                                <h6 class="mb-0"><i class="bi bi-database me-2"></i>System Data Overview</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${data.data_counts.filter(item => item.type !== 'sections').map(item => `
                                        <div class="col-md-4 mb-3">
                                            <div class="text-center p-3 border rounded-3">
                                                <i class="bi bi-${getDataTypeIcon(item.type)} text-primary mb-2" style="font-size: 2rem;"></i>
                                                <h6 class="text-capitalize">${item.type}</h6>
                                                <h4 class="text-primary">${item.count}</h4>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function loadSystemSettings() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/system/settings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load system settings');
                }
                
                const settings = await response.json();
                displaySystemSettings(settings);
            } catch (error) {
                console.error('Error loading system settings:', error);
                document.getElementById('systemSettingsContainer').innerHTML = `
                    <div class="alert alert-danger border-0 rounded-4" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load system settings. Please try again.
                    </div>
                `;
            }
        }
        
        function displaySystemSettings(settings) {
            const container = document.getElementById('systemSettingsContainer');
            
            let html = `
                <div class="row g-4">
                    ${settings.map(setting => `
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm rounded-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">${setting.setting_key}</h6>
                                        <span class="badge bg-secondary">${setting.setting_type}</span>
                                    </div>
                                    <p class="card-text small text-muted">${setting.description || 'No description available'}</p>
                                    ${setting.setting_type === 'boolean' ? `
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                       class="form-check-input" 
                                                       id="setting-${setting.setting_key}" 
                                                       ${setting.setting_value === 'true' ? 'checked' : ''}>
                                                <label class="form-check-label" for="setting-${setting.setting_key}">
                                                    ${setting.setting_value === 'true' ? 'Enabled' : 'Disabled'}
                                                </label>
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm" onclick="updateSetting('${setting.setting_key}', '${setting.setting_type}')">
                                                <i class="bi bi-check"></i> Update
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="input-group">
                                            <input type="${getInputType(setting.setting_type)}" 
                                                   class="form-control" 
                                                   id="setting-${setting.setting_key}" 
                                                   value="${setting.setting_value}">
                                            <button class="btn btn-outline-primary" onclick="updateSetting('${setting.setting_key}', '${setting.setting_type}')">
                                                <i class="bi bi-check"></i>
                                            </button>
                                        </div>
                                    `}
                                    <small class="text-muted">Last updated: ${new Date(setting.updated_at).toLocaleString()}</small>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="showAddSettingModal()">
                        <i class="bi bi-plus-circle me-1"></i>Add New Setting
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function updateSetting(key, type) {
            const input = document.getElementById(`setting-${key}`);
            let value;
            
            // Handle different input types
            if (type === 'boolean') {
                value = input.checked ? 'true' : 'false';
            } else {
                value = input.value;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/system/settings/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        value: value,
                        type: type
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update setting');
                }
                
                showAlert('Setting updated successfully!', 'success');
                recordActivity('settings_update', `Updated setting: ${key} = ${value}`);
                
                // For boolean settings, update the label immediately
                if (type === 'boolean') {
                    const label = input.nextElementSibling;
                    if (label) {
                        label.textContent = value === 'true' ? 'Enabled' : 'Disabled';
                    }
                }
                
                loadSystemSettings(); // Refresh the settings
            } catch (error) {
                console.error('Error updating setting:', error);
                showAlert('Failed to update setting. Please try again.', 'danger');
            }
        }
        
        function refreshAnalytics() {
            const activeTab = document.querySelector('#analyticsTabsContent .tab-pane.active');
            if (activeTab && activeTab.id === 'overview') {
                loadAnalyticsOverview();
            } else if (activeTab && activeTab.id === 'user-activity') {
                loadUserActivity();
            } else if (activeTab && activeTab.id === 'system-metrics') {
                loadSystemMetrics();
            }
        }
        
        function refreshSettings() {
            loadSystemSettings();
        }
        
        // Helper functions
        function getRoleColor(role) {
            const colors = {
                'admin': 'danger',
                'dean': 'primary',
                'chair': 'info',
                'secretary': 'warning'
            };
            return colors[role] || 'secondary';
        }
        
        function getStatusColor(status) {
            const colors = {
                'active': 'success',
                'pending': 'warning',
                'inactive': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getScheduleStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function getDataTypeIcon(type) {
            const icons = {
                'subjects': 'book',
                'teachers': 'person-badge',
                'rooms': 'building',
                'sections': 'collection'
            };
            return icons[type] || 'file';
        }
        
        function getInputType(settingType) {
            const types = {
                'boolean': 'checkbox',
                'integer': 'number',
                'string': 'text'
            };
            return types[settingType] || 'text';
        }
        
        function showAddSettingModal() {
            // This would open a modal to add new settings
            // For now, we'll show an alert
            alert('Add new setting functionality would be implemented here with a modal form.');
        }
    </script>
</body>
</html>
        